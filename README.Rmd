---
output:
  md_document:
    variant: markdown_github
---

```{r, echo = FALSE}
knitr::opts_chunk$set(
  collapse = TRUE,
  comment = "#>",
  fig.path = "README-"
)
```

[![CRAN Version](http://www.r-pkg.org/badges/version/spacyr)](http://cran.r-project.org/package=spacyr) ![Downloads](http://cranlogs.r-pkg.org/badges/spacyr) [![Travis-CI Build Status](https://travis-ci.org/kbenoit/spacyr.svg?branch=master)](https://travis-ci.org/kbenoit/spacyr) [![codecov.io](https://codecov.io/github/kbenoit/spacyr/spacyr.svg?branch=master)](https://codecov.io/github/kbenoit/spacyr/coverage.svg?branch=master)

(note: the Travis build fails because our script does not install spaCy and the English language files - once these are installed, it passes the R Check.)

# spacyr: an R wrapper for spaCy

This package is an R wrapper to the spaCy "industrial strength natural language processing" Python library from http://spacy.io.

### Prerequisites

1.  Python (> 2.7 or 3) must be installed on your system.  

2.  spaCy must be installed on your system.  Follow [these instructions](http://spacy.io/docs/). 

    Installation on Windows:  
    a)  (If you have not yet installed Python:)  Download and install [Python for Windows](https://www.python.org/downloads/windows/).  We recommend the 2.7.12, using (if appropriate) the Windows x86-64 MSI installer.  During the installation process, be sure to scroll down in the installation option window and find the "Add Python.exe to Path", and click on the small red "x."  
    b)  Install spaCy and the English language model using these commands at the command line:  
        ```
        pip install -U spacy
        python -m spacy.en.download
        ```
        For alternative installations or troubleshooting, see the [spaCy docs](https://spacy.io/docs/).  
    c)  Test your installation at the command line using:  
        ```
        python -c "import spacy; spacy.load('en'); print('OK')"
        ```

3.  You need (of course) to install this package:  
    ```{r, eval = FALSE}
    devtools::install_github("kbenoit/spacyr")
    ```
    If the python executable in your system is different from the system default python, see the instruction below. 

### Examples

The `spacy_parse()` function calls spaCy to both tokenize and tag the texts. In addition, it provides a functionalities of dependency parsing and named entity recognition. The function returns a `data.table` of the results. The approach to tokenizing taken by spaCy is inclusive: it includes all tokens without restrictions.  The default method for `tag()` is the [Google tagset for parts-of-speech](https://github.com/slavpetrov/universal-pos-tags).

```{r}
require(spacyr)
# start a python process and initialize spaCy in it.
# it takes several seconds for initialization.
spacy_initialize()

txt <- c(fastest = "spaCy excells at large-scale information extraction tasks. It is written from the ground up in carefully memory-managed Cython. Independent research has confirmed that spaCy is the fastest in the world. If your application needs to process entire web dumps, spaCy is the library you want to be using.",
         getdone = "spaCy is designed to help you do real work — to build real products, or gather real insights. The library respects your time, and tries to avoid wasting it. It is easy to install, and its API is simple and productive. I like to think of spaCy as the Ruby on Rails of Natural Language Processing.")

# process documents and obtain a data.table
parsedtxt <- spacy_parse(txt)
head(parsedtxt)
```

By default, `spacy_parse()` conduct tokenization and part-of-speech (POS) tagging. spacyr provides two tagsets, coarse-grained [Google](https://github.com/slavpetrov/universal-pos-tags) tagsets and finer-grained [Penn Treebank](https://www.ling.upenn.edu/courses/Fall_2003/ling001/penn_treebank_pos.html) tagsets. The `google` or `penn` field in the data.table corresponds to each of these tagsets.


Many of the standard methods from [**quanteda**](http://githiub.com/kbenoit/quanteda) work on the new tagged token objects:
```{r}
require(quanteda, warn.conflicts = FALSE, quietly = TRUE)
docnames(parsedtxt)
ndoc(parsedtxt)
ntoken(parsedtxt)
ntype(parsedtxt)
```

### Document processing with addiitonal features

The following codes conduct more detailed document processing, including dependency parsing and named entitiy recognition.

```{r}
results_detailed <- spacy_parse(txt,
                                pos_tag = TRUE,
                                named_entity = TRUE,
                                dependency = TRUE)
head(results_detailed, 30)
```

## Rcpp backend implementation

This package has two ways to call python from R, through `rPython` and `Rcpp`. By default, the package uses `rPython` connection, but the `Rcpp` connection is slightly faster because of the difference in transfering an python objects to R. One can use `Rcpp` implementation by just setting the option of `python_exec = 'Rcpp'` in initialization and parse. 

```{r}
require(spacyr)
# start a python process and initialize spaCy in it.
# it takes several seconds for initialization.
spacy_initialize(python_exec = 'Rcpp')

txt <- c(fastest = "spaCy excells at large-scale information extraction tasks. It is written from the ground up in carefully memory-managed Cython. Independent research has confirmed that spaCy is the fastest in the world. If your application needs to process entire web dumps, spaCy is the library you want to be using.",
         getdone = "spaCy is designed to help you do real work — to build real products, or gather real insights. The library respects your time, and tries to avoid wasting it. It is easy to install, and its API is simple and productive. I like to think of spaCy as the Ruby on Rails of Natural Language Processing.")

# process documents and obtain a data.table
parsedtxt <- spacy_parse(txt, python_exec = 'Rcpp')
head(parsedtxt)
```




## Notes for Mac Users using Homebrew (or other) Version of Python

If you install Python other than the system default and installed spaCy on that Python, there are a few extra steps for installing the package. This package uses two implementations for connecting R and python through `rPython` and `Rcpp`. For each of them the python path has to be set correctly. In the following example, we assume that the correct python path is `/usr/local/bin/python`.

First, you might have to reinstall `rPython` to re-set the python path. In order to check whether this is an issue, check the versions of Pythons in Terminal and R. 

In Terminal, type
```
$ python --version
```
and in R, enter following
```{r}
library(rPython)
python.exec("import platform\nprint(platform.python_version())")
```
If the outputs are different, loading spaCy will fail as the python executable the R system calls is different from the version of python spaCy is intalled.

To resolve the issue, you can alter an environmental variable and then reinstall rPython. Suppose that your brew python is in `/usr/local/bin`, run the following:
```{r, eval = FALSE}
Sys.setenv(PATH=paste("/usr/local/bin",Sys.getenv("PATH"), sep=":"))
install.packages("rPython", type = "source")
```
Once installation is done, restart R then execute commands above again to check the version of Python calling from rPython.

Second, you need to set the python path for `Rcpp` appropriately. The path is set when `spacy` is installed. The path has to be set as an environmental variable before the installation. 

```{r, eval = FALSE}
Sys.setenv(SPACY_PYTHON="/usr/local/bin/python")
devtools::install_github("kbenoit/spacyr")
```
Once the package is installed, check whether the package can find spaCy, by running initialization function for both `rPython` and `Rcpp`.
```{R, eval=FALSE}
spacy_initialize('rPython')
spacy_initialize('Rcpp')
```




## Comments and feedback

We welcome your comments and feedback.  Please file issues on the issues page, and/or send us comments at kbenoit@lse.ac.uk and A.Matsuo@lse.ac.uk.


